---
title: "DIFFERENTIAL_EXPRESSION"
author: "Tamar Feldman"
date: '2023-05-01'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# LOAD LIBRARIES
```{r}
library(DESeq2)
library(IHW)
library(ggplot2)
```

# LOAD FILES
```{r}
my.col.file <-
  "../REFERENCE_FILES/DIFFERENTIAL_EXPRESSION/HumanColData_DESeq2_Input.csv"
my.col <- read.csv(file <- my.col.file, header = T, row.names = 1)

my.count.file <-
  "../PROCESSED_DATA/ALIGNMENT_RESULTS/HumanGeneCountsTable_v2.csv"
my.counts <-
  read.csv(file = my.count.file,
           header = T,
           row.names = 1)

# CHECK THAT COLUMN DATA AND COUNTS DATA ARE COMPATIBLE
all(rownames(my.col) %in% colnames(my.counts))
all(rownames(my.col) == colnames(my.counts))
```

# FUNCTIONS
## FILTER COLUMN DATA AND COUNT MATRIX
```{r}
filter.coldata <-
  function(my.cell, coldata) {
    my.filter <- grepl(my.cell, row.names(coldata), fixed = TRUE)
    return(coldata[my.filter,])
  }

filter.counts <-
  function(my.cell, countdata){
    my.filter <- grepl(my.cell, colnames(countdata), fixed = TRUE)
    return(countdata[,my.filter])
  }
```

## MAKE DESEQ2 OBJECT
```{r}
my.conditions <- c("Media","SRS","Uninfected","Infected")
make.object <-
  function(filtered.coldata, filtered.counts, conditions){
    filtered.coldata$condition <- factor(filtered.coldata$condition, 
                                         levels = conditions)
    
    dds <- DESeqDataSetFromMatrix(countData = filtered.counts,
                                  colData = filtered.coldata,
                                  design = ~ condition)
    
    keep <- rowSums(counts(dds)>=10) >= 4 # LOW COUNT FILTER
    dds <- dds[keep,]
    return(dds)
  }

```

## EXPORT CPM
```{r}
export.cpm <-
  function(dds, outdir, my.cell) {
    outfile <- paste(Sys.Date(), "CPM", my.cell, sep = "-")
    outpath <- paste(outdir, my.cell, "CPM", outfile, sep = "/")
    
    raw.counts <- counts(dds, normalized = F) # GET COUNTS
    
    # MAKE NUMERICS AND TRANSFORM TO DATAFRAME
    RNA.counts <-
      as.data.frame(apply(raw.counts, 2, as.numeric))[, 1:dim(raw.counts)[[2]]]
    
    # CALCULATE CPM
    cpm <-
      sweep(RNA.counts, 2, colSums(RNA.counts), FUN = "/") * 1000000
    rownames(cpm) <-
      rownames(raw.counts) # ADD BACK GENE IDS AS ROW NAMES
    write.csv(
      x = cpm,
      file = paste0(outpath,".csv"),
      row.names = T,
    )
    return(cpm)
  }
```

## RESULTS FUNCTION
```{r}
my.contrasts <-
  list(
    c("SRS", "Media"),
    c("Uninfected", "Media"),
    c("Uninfected", "SRS"),
    c("Infected", "Media"),
    c("Infected", "SRS"),
    c("Infected","Uninfected")
  )

make.results <-
  function(dds, con, my.cell,outdir) {
    outfile1 <-
      paste(Sys.Date(), my.cell, con[[1]], "vs", con[[2]], sep = "-")
    outfile2 <-
      paste(Sys.Date(), my.cell, con[[1]], "vs", con[[2]], "Summary", sep = "-")
    
    outpath1 <-
      paste(outdir, my.cell, "DIFFERENTIAL_EXPRESSION", outfile1, sep = "/")
    outpath2 <-
      paste(outdir, my.cell, "DIFFERENTIAL_EXPRESSION", outfile2, sep = "/")
    
    res <-
      results(
        dds,
        contrast = c("condition", con[[1]], con[[2]]),
        alpha = 0.05,
        filterFun = ihw
      )
    
    write.csv(x = res, file = paste0(outpath1,".csv"), row.names = T)
    capture.output(summary(res), file = paste0(outpath2, ".txt"))
  }
```

## MASTER FUNCTION
```{r}
my.master.function <-
  function(my.cell, my.counts, my.col, my.outdir) {
    my.filtered.counts <-
      filter.counts(my.cell = my.cell, countdata = my.counts)
    
    my.filtered.coldata <-
      filter.coldata(my.cell = my.cell, coldata = my.col)
    
    my.dds <-
      make.object(
        filtered.coldata = my.filtered.coldata,
        filtered.counts = my.filtered.counts,
        conditions = my.conditions
      )
    
    my.cpm <-
      export.cpm(dds = my.dds,
                 outdir = my.outdir,
                 my.cell = my.cell)
    
    my.dds <- DESeq(my.dds)
    
    for (my.contrast in my.contrasts) {
      make.results(
        dds = my.dds,
        con = my.contrast,
        my.cell = my.cell,
        outdir = my.outdir
      )
    }
  }

```

## MASTER FUNCTION FOR PARASITE CPM

```{r}
make.object.parasite <-
  function(filtered.coldata, filtered.counts, conditions){
    filtered.coldata$condition <- factor(filtered.coldata$condition, 
                                         levels = conditions)
    
    dds <- DESeqDataSetFromMatrix(countData = filtered.counts,
                                  colData = filtered.coldata,
                                  design = ~ 1)
    
    keep <- rowSums(counts(dds)>=10) >= 4 # LOW COUNT FILTER
    dds <- dds[keep,]
    return(dds)
  }

my.master.function.parasite <-
  function(my.cell, my.counts, my.col, my.outdir) {
    my.filtered.counts <-
      filter.counts(my.cell = my.cell, countdata = my.counts)
    
    my.filtered.coldata <-
      filter.coldata(my.cell = my.cell, coldata = my.col)
    
    my.filtered.coldata <-
      filter.coldata("Infected", my.filtered.coldata)
    
    my.filtered.counts <-
      filter.counts("Infected", my.filtered.counts)
    
    my.dds <-
      make.object.parasite(
        filtered.coldata = my.filtered.coldata,
        filtered.counts = my.filtered.counts,
        conditions = my.conditions
      )
    
    my.cpm <-
      export.cpm(dds = my.dds,
                 outdir = my.outdir,
                 my.cell = my.cell)
  }

```


# RUN MASTER FUNCTION: PROE
```{r}
my.master.function(
    my.cell = "ProE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS"
)
```

# RUN MASTER FUNCTION: BASOE
```{r}
my.master.function(
    my.cell = "BasoE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS"
)
```

# RUN MASTER FUNCTION: POLYE
```{r}
my.master.function(
    my.cell = "PolyE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS"
)
```

# RUN MASTER FUNCTION: ORTHOE
```{r}
my.master.function(
    my.cell = "OrthoE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS"
)
```

# PREPARE FOR PARASITE GENES
```{r}
my.col.file <-
  "../REFERENCE_FILES/DIFFERENTIAL_EXPRESSION/HumanColData_DESeq2_Input.csv"
my.col <- read.csv(file <- my.col.file, header = T, row.names = 1)

my.count.file <-
  "../PROCESSED_DATA/ALIGNMENT_RESULTS/PfGeneCountsTable_v2.csv"
my.counts <-
  read.csv(file = my.count.file,
           header = T,
           row.names = 1)

# CHECK THAT COLUMN DATA AND COUNTS DATA ARE COMPATIBLE
all(rownames(my.col) %in% colnames(my.counts))
all(rownames(my.col) == colnames(my.counts))
```

# RUN MASTER PARASITE FUNCTION FOR PROE
```{r}
my.master.function.parasite(
    my.cell = "ProE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS/PARASITE"
)
```

# RUN MASTER PARASITE FUNCTION FOR BASOE
```{r}
my.master.function.parasite(
    my.cell = "BasoE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS/PARASITE"
)
```

# RUN MASTER PARASITE FUNCTION FOR POLYE
```{r}
my.master.function.parasite(
    my.cell = "PolyE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS/PARASITE"
)
```

# RUN MASTER PARASITE FUNCTION FOR ORTHOE
```{r}
my.master.function.parasite(
    my.cell = "OrthoE",
    my.counts = my.counts,
    my.col = my.col,
    my.outdir = "../PROCESSED_DATA/DESEQ2_RESULTS/PARASITE"
)
```
